import{O as Z,c as q,i as v,a as m,h as A,N as j,$ as G,g as N,f as J,j as H,s as U,t as x,F as W,a5 as O,d as V,E as X,D as p,Z as ee,a6 as te,Q as F,Y as D,k as ae,_ as ne}from"./index-69f0698f.js";import{I as le}from"./code-0a2ad5d4.js";const I={Full:0,Half:1,Child:2,Shallow:3};class B{data=[];dataMap={};valueMap={};mode=1;lastSelected="";levels=[];checkRelation="related";constructor(e){this.data=e.data,this.checkRelation=e.checkRelation,this.setData(this.data),this.setValue(e.value),this.initDisabled(null,!1)}setData(e){this.dataMap={},this.valueMap={},this.data=e,this.links={},this.levels=[],e&&this.initData(null,e,0)}initData(e,a,l){const c=[];return this.levels[l]=[],a.forEach(s=>{s._level=l,c.push(s.id),this.dataMap[s.id]=s;const d={};if(this.links[s.id]=d,d.parent=e?e.id:null,this.levels[l].push(s.id),s.children){const f=this.initData(s,s.children,l+1);d.children=f}}),c}initValue(e,a){if(!this.data||!a)return 0;e||(e=this.levels[0]);let l;return e?.forEach(c=>{const s=this.links[c].children;let d=a.includes(c)?1:0;s&&s.length>0&&(this.checkRelation==="related"?d=this.initValue(s,a):this.initValue(s,a)),this.setValueMap(c,d),l===void 0?l=d:l!==d&&(l=2)}),l}initDisabled(e,a){e||(e=this.levels[0]),e?.forEach(l=>{const c=this.dataMap[l].disabled||a;this.dataMap[l].disabled=c;const s=this.links[l].children;s&&s.length>0&&this.initDisabled(s,c)})}setValue(e){this.initValue(null,e)}setValueMap(e,a){this.valueMap[e]=a}getAllChecked(){const e=[];for(const a in this.valueMap)this.valueMap[a]&&e.push(a);return e}getParentIds(e,a){a.push(e);const l=this.links[e];l.parent&&this.getParentIds(l.parent,a)}getOpened(){const e=[];return this.dataMap.forEach(a=>{a._open&&e.push(a.id)}),e}getValue(e){const a=[];for(const l in this.valueMap){const c=this.valueMap[l];switch(e){case I.Full:c===1&&a.push(l);break;case I.Half:c>=1&&a.push(l);break;case I.Child:{const s=this.links[l].children;c===1&&(!s||s.length===0)&&a.push(l);break}case I.Shallow:c===1&&((()=>{const d=this.links[l].parent;return d?this.valueMap[d]===1:!1})()||a.push(l));break}}return a}getAllCheckedData(e){const a=[];return e.forEach(l=>{const c=this.dataMap[l];a.push(c)}),a}getText(e){const a=[];return e.forEach(l=>{const c=this.dataMap[l];a.push(c.title)}),a}ifSets(e){const a={};e.forEach(c=>{this.ifSet(c,1,"",a)});const l=[];for(const c in a)a[c]&&l.push(c);return l}ifSet(e,a,l,c){this.isDisabled(e)||(c[e]=a);const{parent:s,children:d}=this.links[e];if(l!=="asc"&&d&&d.forEach(f=>{this.ifSet(f,a,"desc",c)}),l!=="desc"&&s){const f=s;let C=a;this.links[f].children.forEach(b=>{C!==c[b]&&(C=2)}),this.ifSet(f,C,"asc",c)}}set(e,a,l){if(this.isDisabled(e)||this.setValueMap(e,a),this.checkRelation==="unRelated")return;const{parent:c,children:s}=this.links[e];if(l!=="asc"&&s&&s.forEach(d=>{this.set(d,a,"desc")}),l!=="desc"&&c){const d=c;let f=a;this.links[d].children.forEach(C=>{f!==this.valueMap[C]&&(f=2)}),this.set(d,f,"asc")}}disabledNode(e){this.initDisabled([e],!0)}isDisabled(e){const a=this.dataMap[e];return a?a.disabled:!1}addChildren(e,a){this.dataMap[e]&&a.forEach(d=>{this.dataMap[d.id]=d});const c=this.links[e],s=a.map(d=>{const f={};return this.links[d.id]=f,f.parent=e,d.id});c.children=s}}const ce=x('<span class="cm-tree-item-folder">'),se=x('<span class="cm-tree-item-file">'),ie=x('<span class="cm-tree-item-icon">'),de=x('<li><div class="cm-tree-item-content"><span><span class="cm-tree-text">'),re=x('<span><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3571" width="16" height="16"><path d="M323.731 93.334c14.331 0 27.677 5.512 37.657 15.529l365.34 365.99c1.337 1.306 2.38 2.417 3.234 3.607l2.16 2.723c10.653 10.703 15.888 23.296 15.888 36.627 0 13.571-5.351 26.26-15.053 35.73l-367.853 363.953c-9.951 9.813-23.238 15.222-37.401 15.222-13.848 0-26.931-5.25-36.832-14.769-9.841-9.549-15.507-22.867-15.506-36.518 0-13.484 5.365-26.259 15.134-35.969l331.846-328.283-336.081-336.964c-9.607-9.666-14.915-22.296-14.915-35.619 0-13.958 5.673-27.055 15.937-36.876 9.768-9.271 22.734-14.381 36.444-14.381z" p-id="3572">'),ue=x('<span class="cm-tree-patch">');function oe(t){const e=fe(),[a,l]=q(!1),c=()=>({"padding-left":t.level*t.gutter+"px"}),s=()=>t.store.dataMap[t.data.id]._opened,d=()=>t.store.dataMap[t.data.id]._selected,f=()=>({"cm-tree-item":!0,"cm-tree-item-open":s(),"cm-tree-item-selected":d()}),C=()=>{let u=t.directory?h()?ce():se():null;return t.data.icon&&(u=(()=>{const g=ie();return v(g,()=>t.data.icon),g})()),u},b=()=>{t.store.dataMap[t.data.id].disabled||e&&e.onSelect&&e.onSelect(t.data)},r=async()=>{if(e){const u=t.store.dataMap[t.data.id];if(u.loading&&e.loadData){l(!0);try{const g=await e.loadData(t.data);g instanceof Array?e.addChildren(u.id,t.data,g):e.addChildren(u.id,t.data,[g]),e.cancelLoading(u.id)}catch{}finally{l(!1)}}e.onOpenClose(t.data.id)}},k=u=>{e&&e.onChecked(t.data.id,u)},h=()=>t.data.children&&t.data.children.length||t.data.loading,L=()=>{let u=0;return u=t.store.checkedMap[t.data.id],u===2?"indeterminate":u===1},R=u=>{e&&e.contextMenu&&e.onContextMenu&&e.onContextMenu({...t.data})};return(()=>{const u=de(),g=u.firstChild,_=g.firstChild,w=_.firstChild;return v(g,m(N,{get when(){return a()},get fallback(){return(()=>{const M=re();return M.$$click=r,A(()=>j(M,`cm-tree-arrow ${h()?"":"hide"}`)),M})()},get children(){return m(G,{color:"#1890ff",size:16})}}),_),v(g,m(N,{get when(){return t.multi},get children(){return m(le,{get disabled(){return t.store.dataMap[t.data.id].disabled},get checked(){return L()},onChange:k})}}),_),v(g,C,_),_.$$contextmenu=R,w.$$click=b,v(w,()=>t.data.title),v(_,(()=>{const M=J(()=>!!t.data.patch);return()=>M()?(()=>{const S=ue();return v(S,()=>t.data.patch),S})():null})(),null),v(u,m(N,{get when(){return t.data.children&&t.data.children.length},get children(){return m(P,{onSelect:b,get multi(){return t.multi},get directory(){return t.directory},get store(){return t.store},get data(){return t.data.children},get level(){return t.level+1},get gutter(){return t.gutter}})}}),null),A(M=>{const S=f(),T=c(),E=`cm-tree-title ${t.store.dataMap[t.data.id].disabled?"disabled":""}`;return M._v$=H(u,S,M._v$),M._v$2=U(g,T,M._v$2),E!==M._v$3&&j(_,M._v$3=E),M},{_v$:void 0,_v$2:void 0,_v$3:void 0}),u})()}Z(["contextmenu","click"]);const he=x('<ul class="cm-tree-nodes">');function P(t){return(()=>{const e=he();return v(e,m(W,{get each(){return t.data},children:a=>m(oe,{data:a,get store(){return t.store},get level(){return t.level},get gutter(){return t.gutter},get multi(){return t.multi},get directory(){return t.directory}})})),e})()}const K=x("<div>"),Q=ee();function ke(t){const e=()=>ae(t,"cm-tree"),[a,l]=O(t,"value",""),[c,s]=O(t,"opened",[]),[d,f]=O(t,"selected",""),C=t.gutter??24,b=t.checkRelation??"related";let r=new B({value:a()||[],checkRelation:b,data:t.data});V(()=>{r=new B({value:[],checkRelation:b,data:t.data}),te(()=>{h("data",t.data),h("dataMap",r.dataMap),h("selected",""),h("openIds",[]),h("checkedMap",{...r.valueMap})}),F(()=>{})});const[k,h]=X({data:t.data,dataMap:r.dataMap,selected:"",openIds:[],checkedMap:{...r.valueMap}}),L=n=>{const i=c();i.includes(n)||(i.push(n),s([...i]))},R=n=>{const i=c();if(i.includes(n)){const o=i.indexOf(n);i.splice(o,1),s(i)}},u=(n,i)=>{r.set(n,i?1:0,"");const o=r.getAllChecked();l(o)};V(()=>{const n=c();F(()=>{k.openIds.forEach(i=>{n.includes(i)||h("dataMap",i,D(o=>{o._opened&&(o._opened=!1)}))})}),n.forEach(i=>{h("dataMap",i,D(o=>{o._opened||(o._opened=!0)}))}),h("openIds",n.concat([]))}),V(()=>{const n=d();h("dataMap",k.selected,D(i=>{i._selected=!1})),h("dataMap",n,D(i=>{i._selected=!0})),h("selected",n)}),V(()=>{let n=a();t.multi&&typeof n=="string"&&(n=n.split(",")),r.setValue(n);const i=r.getAllChecked(),o=[];F(()=>{for(const $ in k.checkedMap)k.checkedMap[$]&&!n.includes($)&&o.push($)}),o.forEach($=>{h("checkedMap",$,r.valueMap[$])}),i&&i.forEach($=>{h("checkedMap",$,r.valueMap[$])})});const g=n=>{const i=c();if(i.includes(n)){const o=i.indexOf(n);i.splice(o,1)}else i.push(n);s([...i])},_=n=>{f(n.id),t.onSelect&&t.onSelect(n)},w=n=>{f(n)},M=(n,i)=>{r.set(n,i?1:0,"");const o=r.getAllChecked();l(o),t.onChange&&t.onChange(o)},S=(n,i,o)=>{if(k.dataMap[n]){r.addChildren(n,o),r.set(n,0,"");const Y=r.getAllChecked();l(Y),h("dataMap",n,D(y=>{y.children=[],setTimeout(()=>{y.children=o})})),h("dataMap",D(y=>{o.map(z=>{y[z.id]=z})}))}},T=n=>{h("dataMap",n,"loading",!1)},E=()=>k.dataMap[k.selected];return t.ref&&t.ref({openNode:L,closeNode:R,checkNode:u,getAllChecked:()=>r.getValue(0),getAllCheckedData:n=>r.getAllCheckedData(n),getHalfChecked:()=>r.getValue(1),getChildChecked:()=>r.getValue(2),getShallowChecked:()=>r.getValue(3),getText:n=>r.getText(n),disabledNode:r.disabledNode,selectNode:w,getSelectNode:E,setValue:n=>{l(n)},getIfSets:n=>r.ifSets(n)}),m(Q.Provider,{get value(){return{signal:[k,h],onSelect:_,onOpenClose:g,onChecked:M,loadData:t.loadData,addChildren:S,cancelLoading:T,onContextMenu:t.onContextMenu,contextMenu:t.contextMenu}},get children(){return m(N,{get when(){return t.contextMenu},get fallback(){return(()=>{const n=K();return v(n,m(P,{store:k,get data(){return k.data},level:0,gutter:C,get multi(){return t.multi},get directory(){return t.directory}})),A(i=>H(n,e(),i)),n})()},get children(){return m(p,{trigger:"contextMenu",handler:".cm-tree-text",align:"bottomLeft",get menu(){return t.contextMenu},get onSelect(){return t.onSelectMenu},get children(){const n=K();return v(n,m(P,{store:k,get data(){return k.data},level:0,gutter:C,get multi(){return t.multi},get directory(){return t.directory}})),A(i=>H(n,e(),i)),n}})}})}})}const fe=()=>ne(Q);export{ke as T};
